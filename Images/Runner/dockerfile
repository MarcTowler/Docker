FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# --------------------------------------------------------
# System Updates & Basic Tools
# --------------------------------------------------------
RUN apt-get update && \
    apt-get install -y \
      curl \
      wget \
      jq \
      git \
      unzip \
      apt-transport-https \
      ca-certificates \
      gnupg \
      software-properties-common \
      build-essential \
      libssl-dev \
      libicu-dev \
      zlib1g-dev \
      python3 \
      python3-pip && \
    rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# Set docker group to match host (IMPORTANT)
# --------------------------------------------------------
# Find GID of docker.sock on host: stat -c "%g" /var/run/docker.sock
# Below assumes typical GID 998. Change if yours differs.
RUN groupadd -g 998 docker || true

# --------------------------------------------------------
# Install Docker CLI
# --------------------------------------------------------
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
        | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo \
        "deb [arch=$(dpkg --print-architecture) \
        signed-by=/etc/apt/keyrings/docker.gpg] \
        https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo $VERSION_CODENAME) stable" \
        > /etc/apt/sources.list.d/docker.list && \
    apt-get update && apt-get install -y docker-ce-cli && \
    rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# Install NodeJS LTS
# --------------------------------------------------------
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# Install PHP + Composer
# --------------------------------------------------------
RUN apt-get update && \
    apt-get install -y \
      php-cli \
      php-zip \
      php-curl \
      php-xml \
      php-mbstring \
      php-json \
      php-gd \
      php-tokenizer && \
    rm -rf /var/lib/apt/lists/*

RUN curl -sS https://getcomposer.org/installer \
    | php -- --install-dir=/usr/local/bin --filename=composer

# --------------------------------------------------------
# Install .NET SDK
# --------------------------------------------------------
RUN wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb && \
    dpkg -i packages-microsoft-prod.deb && \
    rm packages-microsoft-prod.deb && \
    apt-get update && \
    apt-get install -y dotnet-sdk-8.0 && \
    rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# Install GitHub Actions Runner
# --------------------------------------------------------
ARG RUNNER_VERSION="2.319.1"
RUN mkdir -p /actions-runner && cd /actions-runner && \
    curl -fsSL -O \
      https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    tar xzf actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    rm actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    ./bin/installdependencies.sh

# --------------------------------------------------------
# Create non-root runner user
# --------------------------------------------------------
RUN useradd -m runner && \
    usermod -aG docker runner && \
    chown -R runner:runner /actions-runner

# --------------------------------------------------------
# Install Python JWT for GitHub App auth
# --------------------------------------------------------
RUN pip3 install pyjwt cryptography

# --------------------------------------------------------
# Add entrypoint
# --------------------------------------------------------
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# --------------------------------------------------------
# Final container config
# --------------------------------------------------------
WORKDIR /actions-runner
USER root
ENTRYPOINT ["/entrypoint.sh"]
