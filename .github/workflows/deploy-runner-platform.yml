name: Build and Push images
run-name: Build and Push ${{ github.event.inputs.target }} Image
on:
  workflow_dispatch:
    inputs:
      target:
        description: "What Image to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - --- Utility Images ---
          - Github Runners
          - Github Runner Autoscaler
          - Bind9
          - --- Application Images ---
          - ItsLit API
          - GAPI
          - RPG Website
          - Website
          - Socket Server

jobs:
  build-image:
    runs-on: [self-hosted, swarm]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Map the readable name to the actual Dockerfile path
      - name: Map selected target to Dockerfile path
        id: map
        run: |
          # Map the selected target to its Dockerfile and context
          case "${{ github.event.inputs.target }}" in
            "Bind9")
              echo "targets=Bind9" >> "$GITHUB_OUTPUT"
              ;;
            "Github Runners")
              echo "targets=github-runner" >> "$GITHUB_OUTPUT"
              ;;
            "Github Runner Autoscaler")
              echo "targets=runner-autoscaler" >> "$GITHUB_OUTPUT"
              ;;
            "ItsLit API")
              echo "targets=api" >> "$GITHUB_OUTPUT"
              ;;
            "GAPI")
              echo "targets=gapi" >> "$GITHUB_OUTPUT"
              ;;
            "RPG Website")
              echo "targets=rpgsite" >> "$GITHUB_OUTPUT"
              ;;
            "Website")
              echo "targets=site" >> "$GITHUB_OUTPUT"
              ;;
            "Socket Server")
              echo "targets=nodews" >> "$GITHUB_OUTPUT"
              ;;
            "all")
              echo "targets=bind9 github-runner runner-autoscaler api gapi rpgsite site nodews" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unknown target selected"; exit 1 ;;
          esac

      - name: Show resolved paths
        run: |
          echo "Building with:"
          echo "  Dockerfile: ${{ steps.map.outputs.dockerfile }}"
          echo "  Context:     ${{ steps.map.outputs.context }}"

      # Run the actual docker build
      - name: Build Docker image
        run: |
          for target in ${{ steps.map.outputs.targets }}; do
            echo "Building target: $target"

            case "$target" in
              "bind9")
                echo "dockerfile=Images/bind9/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/bind9" >> "$GITHUB_OUTPUT"
                ;;
              "github-runner")
                echo "dockerfile=Images/Runner/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/Runner" >> "$GITHUB_OUTPUT"
                ;;
              "runner-autoscaler")
                echo "dockerfile=Images/RunnerAutoscaler/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/RunnerAutoscaler" >> "$GITHUB_OUTPUT"
                ;;
              "api")
                echo "dockerfile=Images/PHPServer/API/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/PHPServer/API" >> "$GITHUB_OUTPUT"
                ;;
              "gapi")
                echo "dockerfile=Images/PHPServer/gapi/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/PHPServer/gapi" >> "$GITHUB_OUTPUT"
                ;;
              "rpgsite")
                echo "dockerfile=Images/PHPServer/rpg/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/PHPServer/rpg" >> "$GITHUB_OUTPUT"
                ;;
              "site")
                echo "dockerfile=Images/PHPServer/site/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/PHPServer/site" >> "$GITHUB_OUTPUT"
                ;;
              "nodews")
                echo "dockerfile=Images/node/dockerfile" >> "$GITHUB_OUTPUT"
                echo "context=Images/node" >> "$GITHUB_OUTPUT"
                ;;
            esac

            echo "Using Dockerfile: $dockerfile"
            echo "Using Context: $context"
            
            docker build -t registry.itslit/library/$target:latest \
              -f "$dockerfile" \
              "$context"
          done
      - name: Push Docker image
        run: |
          for target in ${{ steps.map.outputs.targets }}; do
            echo "Pushing target: $target"
            docker push registry.itslit/library/$target:latest
          done