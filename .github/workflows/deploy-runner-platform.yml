name: Build and Push Images

on:
  workflow_dispatch:
    inputs:
      target:
        description: "What Image to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - github-runner
          - Runner Autoscaler
          - Bind9
          - API
          - gapi
          - rpgsite
          - Website
          - Socket Server

jobs:
  build-image:
    runs-on: [self-hosted, swarm]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Map the readable name to the actual Dockerfile path
      - name: Map selected target to Dockerfile path
        id: map
        run: |
          case "${{ github.event.inputs.target }}" in
            "API")
              echo "dockerfile=Images/PHPServer/API/dockerfile" >> "$GITHUB_OUTPUT"
              echo "Images/PHPServer/API" >> "$GITHUB_OUTPUT"
              ;;
            "gapi")
              echo "dockerfile=Images/PHPServer/gapi/dockerfile" >> "$GITHUB_OUTPUT"
              echo "context=Images/PHPServer/gapi" >> "$GITHUB_OUTPUT"
              ;;
            "rpgsite")
              echo "dockerfile=Images/PHPServer/site/dockerfile" >> "$GITHUB_OUTPUT"
              echo "context=Images/PHPServer/site" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unknown target selected"; exit 1 ;;
          esac

      - name: Show resolved paths
        run: |
          echo "Building with:"
          echo "  Dockerfile: ${{ steps.map.outputs.dockerfile }}"
          echo "  Context:     ${{ steps.map.outputs.context }}"

      # Run the actual docker build
      - name: Build Docker image
        run: |
          docker build -t registry.itslit/library/${{ github.event.inputs.target | toLowerCase }}:latest \
            -f "${{ steps.map.outputs.dockerfile }}" \
            "${{ steps.map.outputs.context }}"

      # - name: Build Website
      #   run: |
      #     docker build -t registry.itslit/library/website:latest ./Images/PHPServer/site
      #     docker push registry.itslit/library/website:latest