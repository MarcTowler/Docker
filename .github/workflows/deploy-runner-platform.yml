name: Build and Push images
run-name: Build and Push ${{ github.event.inputs.target }} Image
on:
  workflow_dispatch:
    inputs:
      target:
        description: "What Image to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - --- Utility Images ---
          - Base Images
          - Bind9
          - Github Runners
          - Github Runner Autoscaler
          - --- Application Images ---
          - ItsLit API
          - GAPI
          - RPG Website
          - Website
          - Socket Server

jobs:
  build-image:
    runs-on: [self-hosted, swarm]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Map the readable name to the actual Dockerfile path
      - name: Map selected target to Dockerfile path
        id: map
        run: |
          # Map the selected target to its Dockerfile and context
          case "${{ github.event.inputs.target }}" in
            "Bind9")
              echo "targets=Bind9" >> "$GITHUB_OUTPUT"
              ;;
            "Github Runners")
              echo "targets=github-runner" >> "$GITHUB_OUTPUT"
              ;;
            "Github Runner Autoscaler")
              echo "targets=runner-autoscaler" >> "$GITHUB_OUTPUT"
              ;;
            "ItsLit API")
              echo "targets=api" >> "$GITHUB_OUTPUT"
              ;;
            "GAPI")
              echo "targets=gapi" >> "$GITHUB_OUTPUT"
              ;;
            "RPG Website")
              echo "targets=rpgsite" >> "$GITHUB_OUTPUT"
              ;;
            "Website")
              echo "targets=site" >> "$GITHUB_OUTPUT"
              ;;
            "Socket Server")
              echo "targets=nodews" >> "$GITHUB_OUTPUT"
              ;;
            "Base Images") 
              echo "targets=base-images" >> "$GITHUB_OUTPUT"
              ;;
            "all")
              echo "targets=base-images bind9 github-runner runner-autoscaler api gapi rpgsite site nodews" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unknown target selected"; exit 1 ;;
          esac

      # Run the actual docker build
      - name: Build Docker image
        id: build
        run: |
          SUMMARY_FILE="summary.txt"
          echo "| Image | Dockerfile | Context | Tag |" >> $SUMMARY_FILE
          echo "|-------|------------|---------|-----|" >> $SUMMARY_FILE

          for target in ${{ steps.map.outputs.targets }}; do

            # BASE IMAGES LOGIC
            if [ "$target" = "base-images" ]; then
              echo "Processing Base Images..."

              declare -A base_images=(
                ["php"]="php:8.1-apache"
                ["node"]="node:current-alpine"
                ["composer"]="composer:2.4"
                ["mysql"]="mysql:8.0"
              )

              for name in "${!base_images[@]}"; do
                source_tag="${base_images[$name]}"

                echo "Pulling $source_tag..."
                docker pull $source_tag

                dest="registry.itslit/$name:${source_tag#*:}"
                echo "Retagging to $dest"
                docker tag $source_tag $dest

                echo "Pushing $dest"
                docker push $dest

                echo "| $name | (base-image) | DockerHub | $dest |" >> $SUMMARY_FILE
              done

              continue
            fi
            
            echo "Building target: $target"

            case "$target" in
              "bind9")
                dockerfile="Images/bind9/dockerfile"
                context="Images/bind9"
                ;;
              "github-runner")
                dockerfile="Images/Runner/dockerfile"
                context="Images/Runner"
                ;;
              "runner-autoscaler")
                dockerfile="Images/RunnerAutoscaler/dockerfile"
                context="Images/RunnerAutoscaler"
                ;;
              "api")
                dockerfile="Images/PHPServer/API/dockerfile"
                context="Images/PHPServer/API"
                ;;
              "gapi")
                dockerfile="Images/PHPServer/gapi/dockerfile"
                context="Images/PHPServer/gapi"
                ;;
              "rpgsite")
                dockerfile="Images/PHPServer/rpg/dockerfile"
                context="Images/PHPServer/rpg"
                ;;
              "site")
                dockerfile="Images/PHPServer/site/dockerfile"
                context="Images/PHPServer/site"
                ;;
              "nodews")
                dockerfile="Images/node/dockerfile"
                context="Images/node"
                ;;
            esac

            echo "Using Dockerfile: $dockerfile"
            echo "Using Context: $context"

            tag="registry.itslit/library/$target:latest"

            echo "Building $target..."
            docker build -t $tag -f "$dockerfile" "$context"
            docker push $tag

            echo "| $target | $dockerfile | $context | $tag |" >> $SUMMARY_FILE
          done

          echo "summary-path=$SUMMARY_FILE" >> "$GITHUB_OUTPUT"

      # ───────────────────────────────────────────────
      # Publish summary table to GitHub Actions UI
      # ───────────────────────────────────────────────
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          cat "${{ steps.build.outputs.summary-path }}" >> $GITHUB_STEP_SUMMARY