# ğŸ“˜ Local Docker Registry + Mirror + Cleanup

A fully automated, self-hosted Docker registry system running on Docker
Swarm with:

-   HTTPS ingress via Traefik\
-   Daily upstream image mirroring\
-   Weekly garbage collection\
-   Secure webhook notifications retrieved from Vaultwarden\
-   Registry rebuild instructions for disaster recovery

This document summarizes the entire setup and provides operational
commands and procedures.

------------------------------------------------------------------------

# ğŸš€ Architecture Overview

### Components

  -----------------------------------------------------------------------
  Service                           Purpose
  --------------------------------- -------------------------------------
  **registry**                      The private Docker registry exposed
                                    as `registry.itslit`

  **registry_mirror**               Daily job: sync images, update tags,
                                    delete obsolete tags

  **registry_cleanup**              Weekly job: safe garbage collection
                                    of unused blobs

  **Vaultwarden (bw)**              Secure secret storage for webhook URL

  **Traefik**                       HTTPS TLS termination + ingress
                                    routing

  **Swarm CronJob**                 Runs scheduled tasks inside Swarm
  -----------------------------------------------------------------------

------------------------------------------------------------------------

# ğŸ“¦ registry-stack.yml Summary

The stack includes:

### âœ” `registry`

-   Runs behind Traefik at `https://registry.itslit`\
-   Stores images in `./registry/`\
-   Uses self-signed wildcard certs\
-   Deletion enabled for garbage collection

### âœ” `registry_mirror`

-   Runs daily at **02:00**\
-   Uses Bitwarden (Vaultwarden) session token to retrieve webhook URL\
-   Syncs local images with Docker Hub\
-   Pulls, retags, pushes latest versions\
-   Removes upstream-deleted tags\
-   Sends webhook notifications

### âœ” `registry_cleanup`

-   Runs weekly on **Sunday at 03:00**\
-   Safely performs registry garbage collection
    -   Skips if registry is unreachable\
    -   Skips if uploads are active\
-   Sends webhook notifications

### âœ” Secrets

-   `bw_session_token` â†’ A Bitwarden session token accessible only by
    Swarm services

------------------------------------------------------------------------

# ğŸ” Vaultwarden Integration

Both mirror and cleanup jobs:

1.  Read the session token from Docker Swarm secret:

        /run/secrets/bw_session_token

2.  Log into Vaultwarden automatically using:

        bw get item RegistryWebhook --session $BW_SESSION

3.  Extract the webhook URL from:

        .login.password

4.  Use webhook for success/error/skip notifications

------------------------------------------------------------------------

# ğŸ›  Installation of CLI Tools Inside Jobs

Each scheduled job installs:

-   bash
-   jq
-   curl
-   nodejs / npm
-   Bitwarden CLI (`@bitwarden/cli`)

------------------------------------------------------------------------

# ğŸ—‚ Shell Scripts Included

### **mirror-images.sh**

-   Sync upstream Docker Hub repositories\
-   Skip internal repos (`library/*`)\
-   Delete obsolete tags\
-   Push updated images to registry\
-   Send webhook notifications: success, partial, or error

### **registry-cleanup.sh**

-   Retrieve webhook\
-   Check registry health\
-   Detect active uploads\
-   Run garbage collection\
-   Notify results

------------------------------------------------------------------------

# ğŸ›  Commands: Build, Tag, and Push an Image

Below is the standard workflow to build your own images and push them to
the local registry.

------------------------------------------------------------------------

## 1ï¸âƒ£ Build your image locally

``` bash
docker build -t myapp:latest .
```

------------------------------------------------------------------------

## 2ï¸âƒ£ Tag it for the registry

``` bash
docker tag myapp:latest registry.itslit/myapp:latest
```

------------------------------------------------------------------------

## 3ï¸âƒ£ Push to the registry

``` bash
docker push registry.itslit/myapp:latest
```

------------------------------------------------------------------------

## 4ï¸âƒ£ Pull it on another node (optional)

``` bash
docker pull registry.itslit/myapp:latest
```

------------------------------------------------------------------------

## ğŸ’¡ One-liner

``` bash
docker build -t registry.itslit/myapp:latest . && docker push registry.itslit/myapp:latest
```

------------------------------------------------------------------------

# ğŸ”„ Full Disaster Recovery: Rebuilding the Registry From Scratch

Use these steps only in the event of **total data loss**\
(e.g., the storage directory `./registry` is gone).

------------------------------------------------------------------------

## ğŸ§± Step 1 --- Ensure you still have:

-   `registry-stack.yml`\
-   `mirror-images.sh`\
-   `registry-cleanup.sh`\
-   `bw_session_token` Docker secret\
-   SSL certificates in `./certs/`

If **certs are lost**, recreate them or obtain new ones.

------------------------------------------------------------------------

## ğŸªµ Step 2 --- Remove the broken stack (safe to run)

``` bash
docker stack rm registry
```

Wait until all services disappear:

``` bash
docker service ls
```

------------------------------------------------------------------------

## ğŸ“ Step 3 --- Recreate the registry storage directory

``` bash
mkdir -p registry
chown -R 1000:1000 registry
```

------------------------------------------------------------------------

## ğŸš€ Step 4 --- Redeploy the stack

From the directory containing `registry-stack.yml`:

``` bash
docker stack deploy -c registry-stack.yml registry
```

------------------------------------------------------------------------

## ğŸ”’ Step 5 --- Verify the registry is reachable

``` bash
curl -k https://registry.itslit/v2/_catalog
```

You should see:

``` json
{"repositories":[]}
```

(or a list if mirror already repopulated it)

------------------------------------------------------------------------

## ğŸ” Step 6 --- Trigger a manual mirror run (optional)

``` bash
docker service update --force registry_registry_mirror
```

------------------------------------------------------------------------

## ğŸ§¹ Step 7 --- (Optional) Run cleanup manually

``` bash
docker service update --force registry_registry_cleanup
```

------------------------------------------------------------------------

## ğŸ‰ Your registry is fully recovered

The mirror job will repopulate the registry within 24 hours, or you can
manually push important images immediately.

------------------------------------------------------------------------

# ğŸ§° Troubleshooting

### âŒ Cannot push: certificate error

Install the root CA on the host:

``` bash
sudo mkdir -p /etc/docker/certs.d/registry.itslit
sudo cp ./certs/wildcard.crt /etc/docker/certs.d/registry.itslit/ca.crt
sudo systemctl restart docker
```

------------------------------------------------------------------------

### âŒ Mirror or Cleanup jobs not sending notifications

Check if your Vaultwarden session token expired:

``` bash
docker secret rm bw_session_token
echo "<new-session-token>" | docker secret create bw_session_token -
```

Then redeploy stack.

------------------------------------------------------------------------

### âŒ Garbage collection skipped

Possible reasons:

-   Active uploads in `_uploads/`
-   Registry unreachable
-   Registry service name mismatch

------------------------------------------------------------------------

# ğŸ““ Conclusion

This system provides:

-   Secure, self-hosted registry\
-   Automated daily synchronization\
-   Automated weekly garbage collection\
-   Vaultwarden-secured webhooks\
-   Disaster recovery procedures\
-   Build/tag/push workflows

It is production-ready, automated, secure, and fully self-contained.
